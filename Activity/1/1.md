# 01 - SLSA provenanceの生成、検証

## Highlight
### Attacks prevented

SLSAレベルの高いビルダーは各ビルドプロセスを分離された一時的な環境で実行するため、もしビルドプロセスが侵害されたとしても別のビルドへの感染を防止できます。つまり、ビルドプロセスの脅威(E)["ビルドプロセスの侵害"](https://slsa.dev/spec/v1.0/threats)を軽減することができます。ただし、依存関係のキャッシュが適切に管理されていない場合、他のビルドプロセスに影響を与える可能性があるため注意が必要です。

### Provenanceの生成

SLSAのprovenance(来歴)とは、使用されたソースコード、ビルドシステム、ビルド手順、ビルドを開始した人物などの情報のことで、ビルダーによって生成されます。今回は[SLSA GitHub generator](https://github.com/slsa-framework/slsa-github-generator)プロジェクトの、[container generator](https://github.com/slsa-framework/slsa-github-generator/blob/main/internal/builders/container/README.md)を用いてコンテナのprovenance生成を行います。SLSA GitHub generatorはprovenanceのみを生成する機能もあるため、ビルド定義を変更せずにいつものようにコンテナをビルドして、ワークフローの最後にジェネレーターを呼び出すことでprovenanceの生成ができます。

### Provenanceの検証

provenanceの検証には[slsa-verifier](https://github.com/slsa-framework/slsa-verifier)プロジェクトを使用します。検証の際には期待されるビルダーとソースリポジトリ名が必要です。

### Activity1の目標
SLSAレベル3のビルダーであるGitHubActionsとSLSAのプロジェクトを用いて、provenanceの生成と検証をすることが目標です。



## Deep dive
### ワークフローの作成

GitHubにログインした状態でこの[リンク](https://github.com/slsa-framework/oss-na24-slsa-workshop-project1/fork)にアクセスし、[https://github.com/slsa-framework/oss-na24-slsa-workshop-project1](https://github.com/slsa-framework/oss-na24-slsa-workshop-project1)をforkします。

このリポジトリには、仮想的なサーバーをビルドし、そのprovenanceを生成するGitHubワークフロー[.github/workflow/build-echo-server.yml](https://github.com/slsa-framework/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml)が含まれています。以下のステップが含まれています：

1. Dockerレジストリへの[認証](https://github.com/slsa-framework/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml#L33-L41)
1. [コンテナのビルドと、"\<repository-name\>-echo-server"をDockerレジストリにプッシュ](https://github.com/slsa-framework/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml#L49-L56)をします。イメージ名はワークフローの冒頭で[環境変数](https://github.com/slsa-framework/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml#L14)として設定されています。コンテナはシンプルなecho serverで、コードは[images/echo-server/](https://github.com/slsa-framework/oss-na24-slsa-workshop-project1/blob/main/images/echo-server)ディレクトリにあります。
1. 別のジョブで、イメージ名とダイジェストを使用して[container generatorを呼び出し](https://github.com/slsa-framework/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml#L64-L79)ます。重要な点：ダイジェストはレジストリからイメージをプルせずに計算する必要があります。これは、ワークフローのプッシュとプルの間に攻撃者や内部者が悪意のあるイメージをプッシュする可能性があるためです。
1. 最後に[コンテナをプルして実行](https://github.com/slsa-framework/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml#L81-L102)します。


### ワークフローの実行

(1) forkした自分のGitHub上の、oss-na24-slsa-workshop-project1/.github/workflows/build-echo-server.ymlの「laurentsimon」を自分のアカウント名に変更します。

  15: [REGISTRY_USERNAME](https://github.com/slsa-framework/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml#L15): laurentsimon
  
  75: [registry-username](https://github.com/slsa-framework/oss-na24-slsa-workshop-project1/blob/main/.github/workflows/build-echo-server.yml#L75): laurentsimon

(2) DockerのRead/Write/Deleteアクセス権のある[トークンを生成](https://docs.docker.com/security/for-developers/access-tokens/#create-an-access-token)します。

(3) (2)で生成したトークンをREGISTRY_PASSWORDという名称でGitHubに登録します。
手順は下記のページ参照。
https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-a-repository

(4) GitHubで「Build echo-server」のワークフローを[実行](https://docs.github.com/en/actions/using-workflows/manually-running-a-workflow#running-a-workflow)します。
ログ(runのRun it)に以下のようなDockerイメージのIDが表示されるので、コピーしてメモしておきます。検証時に使用します。

docker.io/＜ユーザ名＞/oss-na24-slsa-workshop-project1-echo-server@sha256:xxxxxxx


### provenanceの検証

(1) 以下のコマンドを実行してコンテナの検証をします。
```shell
docker login -u ＜ユーザ名＞ -p ＜Dockerのトークン＞
image=＜DockerイメージのID＞
source_uri=github.com/＜ユーザ名＞/oss-na24-slsa-workshop-project1
slsa-verifier verify-image "${image}" --source-uri "${source_uri}" --builder-id=https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml
```

(2) 以下のコマンドを実行し、証明書の表示をする。
```shell
slsa-verifier verify-image "${image}" --source-uri "${source_uri}" --builder-id=https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml --print-provenance | jq
```

slsa-verifierは以下が証明書に記載されているものと一致すること検証しています：
1. コンテナのダイジェスト
2. リポジトリのソース元
3. 証明書を構築および生成したビルダー



